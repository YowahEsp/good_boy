<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El Mundo Canino - Noticias de Perros</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #a5d6a7;
            --card: #fff;
            --accent: #ff9e01;
            --secondary: #4caf50;
            --text: #333;
            --muted: #777;
            --column-bg-es: rgba(255, 158, 1, 0.08);
            --column-bg-en: rgba(76, 175, 80, 0.08);
            --paw-pattern: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cpath d='M20,20 Q25,10 35,20 T50,20 Q55,25 50,35 T50,50 Q45,55 35,50 T20,50 Q15,45 20,35 T20,20' fill='none' stroke='%23ff9e01' stroke-width='1.5' opacity='0.2'/%3E%3C/svg%3E");
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            background-image: var(--paw-pattern);
            color: var(--text);
            padding: 20px 10px;
            line-height: 1.6;
            min-height: 100vh;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 25px;
            background: linear-gradient(135deg, #4caf50, #81c784, #a5d6a7);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            border: 4px solid #2e7d32;
        }
        header::before {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }
        header::after {
            content: "";
            position: absolute;
            bottom: -30px;
            left: -30px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }
        .leaf-decoration {
            position: absolute;
            font-size: 2rem;
            animation: sway 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
        }
        .leaf-1 { top: 10px; left: 10%; animation-delay: 0s; }
        .leaf-2 { top: 20px; right: 15%; animation-delay: 0.5s; }
        .leaf-3 { bottom: 15px; left: 20%; animation-delay: 1s; }
        .leaf-4 { bottom: 25px; right: 10%; animation-delay: 1.5s; }
        .leaf-5 { top: 30px; left: 30%; animation-delay: 2s; }
        .leaf-6 { bottom: 20px; right: 25%; animation-delay: 2.5s; }
        
        @keyframes sway {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        
        header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3.2rem;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }
        header h1 img {
            height: 120px;
            width: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 4px solid #2e7d32;
            transition: transform 0.3s ease;
        }
        header h1 img:hover {
            transform: scale(1.05);
        }
        header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.3rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        #lang-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
            box-shadow: 0 4px 12px rgba(255, 158, 1, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #lang-toggle:hover {
            transform: scale(1.1);
            background: var(--secondary);
        }
        .columns-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            max-width: 1400px;
            margin: auto;
        }
        .column {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        .column-es { display: block; background: var(--column-bg-es); }
        .column-en { display: none; background: var(--column-bg-en); }
        .column-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }
        .column-es .column-header { border-color: var(--accent); }
        .column-en .column-header { border-color: var(--secondary); }
        .column-header h2 { font-size: 1.4rem; font-family: 'Poppins', sans-serif; }
        .column-es h2 { color: var(--accent); }
        .column-en h2 { color: var(--secondary); }
        .news-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 158, 1, 0.2);
        }
        .card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .card-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .card-content h3 { font-size: 1.1rem; margin-bottom: 8px; font-family: 'Poppins', sans-serif; }
        .source { font-size: 0.85rem; color: var(--accent); margin-bottom: 8px; font-weight: 500; }
        .date { font-size: 0.8rem; color: var(--secondary); margin-bottom: 8px; }
        .description {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 12px;
            flex-grow: 1;
        }
        .card-footer { margin-top: auto; display:flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .card-footer a {
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .translate-btn {
            background-color: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s;
        }
        .translate-btn:hover { background-color: var(--secondary); color: #fff; }
        .translate-btn:disabled { border-color: var(--muted); color: var(--muted); cursor: not-allowed; }
        .loading, .error-message, .no-more-news {
            text-align: center;
            padding: 40px 15px;
            color: var(--muted);
            font-size: 1rem;
        }
        #load-more {
            display: block;
            margin: 25px auto;
            padding: 12px 30px;
            border: 2px solid var(--accent);
            border-radius: 30px;
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        #load-more:hover { background: var(--secondary); border-color:var(--secondary); }
        #load-more:disabled { background: var(--muted); border-color: var(--muted); cursor: not-allowed; }
        
        @media (min-width: 768px) {
            .columns-container { flex-direction: row; }
            .column { flex: 1; }
            .news-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1200px) {
            .news-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <header>
        <div class="leaf-decoration leaf-1">üåø</div>
        <div class="leaf-decoration leaf-2">üçÉ</div>
        <div class="leaf-decoration leaf-3">üå±</div>
        <div class="leaf-decoration leaf-4">üåø</div>
        <div class="leaf-decoration leaf-5">üçÉ</div>
        <div class="leaf-decoration leaf-6">üå±</div>
        <h1>
            <img src="https://www.akc.org/wp-content/uploads/2017/11/Havanese-running-on-the-beach.jpg" alt="el canino logo">
            el canino
        </h1>
        <p>Las √∫ltimas noticias sobre perros, razas, cuidados y entrenamiento</p>
    </header>

    <div class="columns-container">
        <div class="column column-es">
            <div class="column-header">
                <i class="fas fa-flag"></i><h2>Noticias en Espa√±ol</h2>
            </div>
            <div id="news-es" class="news-grid">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Buscando noticias...</div>
            </div>
        </div>

        <div class="column column-en">
            <div class="column-header">
                <i class="fas fa-flag-usa"></i><h2>English News</h2>
            </div>
            <div id="news-en" class="news-grid">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Fetching news...</div>
            </div>
        </div>
    </div>

    <button id="load-more">Cargar m√°s</button>

    <button id="lang-toggle" title="Cambiar idioma"><i class="fas fa-language"></i></button>

    <script>
        const API_KEYS = {
            NEWSAPI: 'aaf83dcbd8694668ad89247b959db678',
            GNEWS: '42dd93284a0abf72a9a646d3b4a9c33e'
        };
        // ‚úÖ URLs de RSS corregidas: sin espacios al final
        const RSS_FEEDS = {
            es: 'https://www.srperro.com/rss/',
            en: 'https://www.dogster.com/feed'
        };
        const CORS_PROXY = 'https://corsproxy.io/?';
        const dogKeywords = ['perro', 'canino', 'cachorro', 'mascota', 'dog', 'puppy', 'canine', 'pet', 'raza', 'breed'];
        
        const DOM = {
            newsEs: document.getElementById('news-es'),
            newsEn: document.getElementById('news-en'),
            colEs: document.querySelector('.column-es'),
            colEn: document.querySelector('.column-en'),
            loadMoreBtn: document.getElementById('load-more'),
            langToggleBtn: document.getElementById('lang-toggle'),
        };

        const state = {
            page: { es: 1, en: 1 },
            viewMode: 'es',
            isLoading: false,
            seenIds: new Set(),
            allNewsLoaded: { es: false, en: false },
            rssFallback: { es: false, en: false }
        };

        function getArticleId(article) {
            return (article.title || '').substring(0, 50).toLowerCase();
        }

        function isDogRelated(article) {
            const text = (article.title + ' ' + (article.description || '')).toLowerCase();
            return dogKeywords.some(keyword => text.includes(keyword));
        }

        async function fetchFromGNews(lang, page) {
            try {
                const query = lang === 'es' ? 'perro OR canino' : 'dog OR canine';
                const url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(query)}&lang=${lang}&page=${page}&max=10&apikey=${API_KEYS.GNEWS}`;
                // ‚úÖ Usamos CORS proxy para mayor compatibilidad
                const res = await fetch(CORS_PROXY + encodeURIComponent(url));
                if (!res.ok) throw new Error(`GNews failed: ${res.status}`);
                const data = await res.json();
                return data.articles?.map(art => ({ ...art, urlToImage: art.image })) || [];
            } catch (e) {
                console.error("GNews Fetch Error:", e);
                return [];
            }
        }

        async function fetchFromNewsAPI(lang, page) {
            try {
                const query = lang === 'es' ? 'perro OR cachorro' : 'dog OR canine';
                const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=${lang}&page=${page}&pageSize=20&sortBy=publishedAt&apiKey=${API_KEYS.NEWSAPI}`;
                const res = await fetch(CORS_PROXY + encodeURIComponent(url));
                if (!res.ok) throw new Error(`NewsAPI failed: ${res.status}`);
                const data = await res.json();
                return data.articles || [];
            } catch (e) {
                console.error("NewsAPI Fetch Error:", e);
                return [];
            }
        }

        async function fetchFromRSS(lang) {
            try {
                const rssUrl = RSS_FEEDS[lang];
                if (!rssUrl) return [];
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
                if (!res.ok) throw new Error(`RSS fetch failed: ${res.status}`);
                const data = await res.json();
                
                return data.items.map(item => ({
                    title: item.title,
                    description: item.description.replace(/<[^>]*>?/gm, '').substring(0, 200) + '...',
                    url: item.link,
                    urlToImage: item.thumbnail,
                    publishedAt: item.pubDate,
                    source: { name: `RSS - ${data.feed.title}` }
                }));
            } catch (e) {
                console.error("RSS Fetch Error:", e);
                return [];
            }
        }

        async function fetchAllNews(lang, page) {
            if (state.rssFallback[lang]) return [];

            // ‚úÖ Intentamos ambas APIs con CORS proxy
            const apiResults = await Promise.allSettled([
                fetchFromGNews(lang, page),
                fetchFromNewsAPI(lang, page),
            ]);

            let combined = [];
            apiResults.forEach(result => {
                if (result.status === 'fulfilled' && Array.isArray(result.value)) {
                    combined.push(...result.value);
                }
            });

            let unique = combined.filter(art => {
                const id = getArticleId(art);
                if (!art.title || !art.url || !art.publishedAt || state.seenIds.has(id) || !isDogRelated(art)) {
                    return false;
                }
                state.seenIds.add(id);
                return true;
            });

            // ‚úÖ Si no hay noticias de APIs, usamos RSS
            if (unique.length === 0 && !state.rssFallback[lang]) {
                console.warn(`APIs for lang '${lang}' returned no valid news. Trying RSS fallback.`);
                unique = await fetchFromRSS(lang);
                state.rssFallback[lang] = true;
            }
            
            return unique.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
        }
        
        const getDogImageUrl = () => {
            const dogImages = [
                'https://images.unsplash.com/photo-1543466835-00a7907e9de1?w=400&h=250&fit=crop&auto=format&q=80',
                'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=400&h=250&fit=crop&auto=format&q=80',
                'https://images.unsplash.com/photo-1552053831-71594a27632d?w=400&h=250&fit=crop&auto=format&q=80'
            ];
            return dogImages[Math.floor(Math.random() * dogImages.length)];
        }

        function renderArticles(articles, container, lang) {
            if (container.querySelector('.loading')) container.innerHTML = '';
            
            if (articles.length === 0) {
                if (container.innerHTML !== '') {
                    if (!container.querySelector('.no-more-news')) {
                        const noMore = document.createElement('div');
                        noMore.className = 'no-more-news';
                        noMore.textContent = 'No se encontraron m√°s noticias.';
                        container.appendChild(noMore);
                    }
                } else {
                    container.innerHTML = '<div class="error-message">No se pudieron cargar noticias. Int√©ntalo m√°s tarde.</div>';
                }
                state.allNewsLoaded[lang] = true;
                updateLoadMoreButton();
                return;
            }
            
            const fragment = document.createDocumentFragment();
            articles.forEach(art => {
                const card = document.createElement('div');
                card.className = 'card';
                const date = new Date(art.publishedAt).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', { dateStyle: 'long' });

                const translateBtnHtml = lang === 'en' ? `
                    <button class="translate-btn"
                            data-title="${(art.title || '').replace(/"/g, '&quot;')}"
                            data-desc="${(art.description || '').replace(/"/g, '&quot;')}">
                        <i class="fas fa-language"></i> Traducir
                    </button>
                ` : '';

                card.innerHTML = `
                    <img src="${art.urlToImage || getDogImageUrl()}" alt="${art.title}" loading="lazy" onerror="this.src='${getDogImageUrl()}'">
                    <div class="card-content">
                        <span class="date"><i class="fas fa-calendar-alt"></i> ${date}</span>
                        <h3>${art.title}</h3>
                        <div class="source"><i class="fas fa-paw"></i> ${art.source.name || 'Fuente desconocida'}</div>
                        ${art.description ? `<div class="description">${art.description}</div>` : ''}
                        <div class="card-footer">
                            ${translateBtnHtml}
                            <a href="${art.url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> Leer m√°s</a>
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            container.appendChild(fragment);
        }
        
        async function handleTranslation(event) {
            const btn = event.target.closest('.translate-btn');
            if (!btn) return;

            const card = btn.closest('.card');
            const titleEl = card.querySelector('h3');
            const descEl = card.querySelector('.description');
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            
            try {
                const text = `${btn.dataset.title} ||| ${btn.dataset.desc}`;
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|es`);
                const data = await res.json();
                const [translatedTitle, translatedDesc] = data.responseData.translatedText.split(' ||| ');
                if (titleEl && translatedTitle) titleEl.textContent = translatedTitle.trim();
                if (descEl && translatedDesc) descEl.textContent = translatedDesc.trim();
                btn.innerHTML = `<i class="fas fa-check"></i> Traducido`;
            } catch (e) {
                btn.innerHTML = `<i class="fas fa-times"></i> Error`;
                setTimeout(() => { btn.disabled = false; btn.innerHTML = `<i class="fas fa-language"></i> Traducir`; }, 2000);
            }
        }

        async function loadNews(isInitial = false) {
            if (state.isLoading) return;
            state.isLoading = true;
            DOM.loadMoreBtn.disabled = true;
            DOM.loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

            const loadForLang = async (lang) => {
                if (state.allNewsLoaded[lang]) return;
                const news = await fetchAllNews(lang, state.page[lang]);
                renderArticles(news, lang === 'es' ? DOM.newsEs : DOM.newsEn, lang);
                if (news.length > 0 && !state.rssFallback[lang]) {
                    state.page[lang]++;
                } else {
                    state.allNewsLoaded[lang] = true;
                }
            };

            if (isInitial) {
                await Promise.all([loadForLang('es'), loadForLang('en')]);
            } else {
                if (state.viewMode === 'es') await loadForLang('es');
                else if (state.viewMode === 'en') await loadForLang('en');
                else if (state.viewMode === 'both') {
                    await Promise.all([
                        DOM.colEs.style.display !== 'none' && loadForLang('es'),
                        DOM.colEn.style.display !== 'none' && loadForLang('en')
                    ].filter(Boolean)); // ‚úÖ Evita pasar "false" a Promise.all
                }
            }

            state.isLoading = false;
            DOM.loadMoreBtn.disabled = false;
            DOM.loadMoreBtn.innerHTML = 'Cargar m√°s';
            updateLoadMoreButton();
        }

        function updateLoadMoreButton() {
            let canLoadMore = false;
            if (state.viewMode === 'es') canLoadMore = !state.allNewsLoaded.es;
            else if (state.viewMode === 'en') canLoadMore = !state.allNewsLoaded.en;
            else if (state.viewMode === 'both') canLoadMore = !state.allNewsLoaded.es || !state.allNewsLoaded.en;

            DOM.loadMoreBtn.style.display = canLoadMore ? 'block' : 'none';
        }
        
        function updateView() {
            DOM.colEs.style.display = (state.viewMode === 'es' || state.viewMode === 'both') ? 'block' : 'none';
            DOM.colEn.style.display = (state.viewMode === 'en' || state.viewMode === 'both') ? 'block' : 'none';
            updateLoadMoreButton();
        }

        DOM.loadMoreBtn.addEventListener('click', () => loadNews(false));
        DOM.newsEn.addEventListener('click', handleTranslation);
        DOM.langToggleBtn.addEventListener('click', () => {
            const modes = ['es', 'en', 'both'];
            const currentIndex = modes.indexOf(state.viewMode);
            state.viewMode = modes[(currentIndex + 1) % modes.length];
            updateView();
        });

        document.addEventListener('DOMContentLoaded', () => loadNews(true));
    </script>
</body>
</html>
